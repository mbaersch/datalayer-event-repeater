___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "DataLayer Event Repeater",
  "categories": [
    "UTILITY"
  ],
  "brand": {
    "id": "mbaersch",
    "displayName": "mbaersch",
    "thumbnail": "data:image/png;base64,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\u003d\u003d"
  },
  "description": "climbs up the dataLayer to a specific event and repeats all events that match a list of desired event keys",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "SIMPLE_TABLE",
    "name": "eventTable",
    "displayName": "Repeat all of the following events...",
    "simpleTableColumns": [
      {
        "defaultValue": "",
        "displayName": "Event Name",
        "name": "eventName",
        "type": "TEXT",
        "isUnique": true,
        "valueHint": "enter event name like \"view_item\""
      }
    ],
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "markerEvent",
    "displayName": "... until this event occus:",
    "simpleValueType": true
  },
  {
    "type": "CHECKBOX",
    "name": "addConditions",
    "checkboxText": "Add conditions (optonal)",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "PARAM_TABLE",
    "name": "additionalChecks",
    "displayName": "Add one or multiple \"key equals value\" conditions (all must be met). Example \"trackingConsent equals true\" . Key must be part of current dataLayer push",
    "paramTableColumns": [
      {
        "param": {
          "type": "TEXT",
          "name": "checkField",
          "displayName": "Key Name",
          "simpleValueType": true,
          "help": "Enter name of a key that has to be present in the event push that is used as condition",
          "valueValidators": [
            {
              "type": "NON_EMPTY"
            }
          ]
        },
        "isUnique": true
      },
      {
        "param": {
          "type": "TEXT",
          "name": "checkValue",
          "displayName": "Value",
          "simpleValueType": true
        },
        "isUnique": false
      }
    ],
    "enablingConditions": [
      {
        "paramName": "addConditions",
        "paramValue": true,
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "CHECKBOX",
    "name": "addRepushMarker",
    "checkboxText": "Add key to all repeated events",
    "simpleValueType": true,
    "help": "Adds a \"isRepeatedEvent\" key with value \"true\" to every handled event",
    "defaultValue": false
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const copyFromWindow = require('copyFromWindow');
const createQueue = require('createQueue');
const log = require('logToConsole');
const makeString = require('makeString');
    
const dataLayerPush = createQueue('dataLayer');
var currentDataLayer = copyFromWindow("dataLayer");  
const mrkKey = data.markerEvent;

for (var i = 0; i < currentDataLayer.length; i++){
  var el = currentDataLayer[i];
  if (el && el.event) {
    //reached marker? 
    if (el.event === mrkKey) {
      var doBreak = true;
      if (data.addConditions === true) {
        data.additionalChecks.forEach((item) => {
          // === would be a problem for all non-string values
          log("check: " + item.checkField + " == " + item.checkValue + ":" + 
              (makeString(el[item.checkField]) == makeString(item.checkValue)));
          doBreak = doBreak && (makeString(el[item.checkField])  == makeString(item.checkValue)); 
        });      
      }
      if (doBreak === true) break;  
    }
  
    //repush current event?
    data.eventTable.forEach((rpekey) => {
      if (el.event === rpekey.eventName) {
        el["gtm.uniqueEventId"] = undefined;
        if (data.addRepushMarker === true)
          el.isRepeatedEvent = true;
        dataLayerPush(el);
      }  
    });      
  }  
}  

data.gtmOnSuccess();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "dataLayer"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 12.11.2023, 01:34:04
